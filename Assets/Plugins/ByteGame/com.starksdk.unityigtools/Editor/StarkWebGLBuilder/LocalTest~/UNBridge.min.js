var UNBridge=function(){};UNBridge.TYPE_CALL=0;UNBridge.TYPE_LISTEN=1;UNBridge.TYPE_UNLISTEN=2;UNBridge.TYPE_EVENT=3;UNBridge.CODE_API_NOT_EXIST=100;UNBridge.CODE_API_NOT_SUPPORT_ASYNC=101;UNBridge.CODE_LACK_PARAM=102;UNBridge.CODE_API_NOT_SUPPORT_SYNC=103;UNBridge.CODE_NOT_MIX_API=104;UNBridge.VERSIONCODE=1;UNBridge.SOURCE_UNITY=1;UNBridge.SOURCE_NATIVE=2;UNBridge.SOURCE_WEBGL=3;UNBridge.TIMEOUT=1E4;UNBridge.unityObjectName="UNBridge";UNBridge.localEventList=[];UNBridge.remoteEventList=[];
UNBridge.callbackMap={};UNBridge.eventCallbackMap={};UNBridge.apiMap={};UNBridge.syncApiMap={};UNBridge.maxTimeout=UNBridge.TIMEOUT;
UNBridge.start=function(){setInterval(function(){for(var a in UNBridge.callbackMap){var b=UNBridge.callbackMap[a];if(void 0!==b&&(new Date).getTime()-b.time>=(void 0!==b.timeout&&0<b.timeout?b.timeout:UNBridge.maxTimeout)){if(b.cb)b.cb.onTimeout();BridgeUtils.mapRemove(UNBridge.callbackMap,a);LogUtil.logD("timeout to remove:"+JSON.stringify(b))}}LogUtil.logD("check timeout.")},1E3);LogUtil.logD("start")};UNBridge.stop=function(){clearInterval();LogUtil.logD("stop")};
UNBridge.setCallbackTimeout=function(a){UNBridge.maxTimeout=a};UNBridge.registerEvent=function(a){BridgeUtils.isInArray(UNBridge.localEventList,a)?LogUtil.logD("registerEvent: event exist:"+a):BridgeUtils.addToArray(UNBridge.localEventList,a)};UNBridge.registerAPI=function(a,b){BridgeUtils.isInMap(UNBridge.apiMap,a)?LogUtil.logD("registerAPI: api exist:"+a):(LogUtil.logD("registerAPI:"+a),BridgeUtils.addToMap(UNBridge.apiMap,a,b))};
UNBridge.registerSyncAPI=function(a,b){BridgeUtils.isInMap(UNBridge.syncApiMap,a)?LogUtil.logD("registerSyncAPI: api exist:"+a):(LogUtil.logD("registerSyncAPI:"+a),BridgeUtils.addToMap(UNBridge.syncApiMap,a,b))};UNBridge.call=function(a,b,c){UNBridge.call(a,b,c,0)};
UNBridge.call=function(a,b,c,d){var e="";c&&(e=MessageUtil.getCallbackId(),BridgeUtils.addToMap(UNBridge.callbackMap,e,{time:(new Date).getTime(),cb:c,timeout:d}));MessageUtil.sendMessage(MessageUtil.packCallMsg(a,b,e));LogUtil.logD("call:"+a)};
UNBridge.sendEvent=function(a,b){LogUtil.logD("remote:"+JSON.stringify(UNBridge.remoteEventList));LogUtil.logD("local:"+JSON.stringify(UNBridge.localEventList));BridgeUtils.isInArray(UNBridge.remoteEventList,a)&&BridgeUtils.isInArray(UNBridge.localEventList,a)?MessageUtil.sendMessage(MessageUtil.packEventMsg(a,b)):LogUtil.logD("sendEvent failed:"+a)};
UNBridge.listen=function(a,b){a&&(BridgeUtils.addToMap(UNBridge.eventCallbackMap,a,b),MessageUtil.sendMessage(MessageUtil.packListenMsg(a)));LogUtil.logD("listen:"+a)};UNBridge.unListen=function(a){a&&(MessageUtil.sendMessage(MessageUtil.packUnListenMsg(a)),BridgeUtils.mapRemove(UNBridge.eventCallbackMap,a));LogUtil.logD("unListen:"+a)};UNBridge.h5HasAPI=function(a){return UNBridge.apiMap[a]?!0:!1};var MessageUtil=function(){};
MessageUtil.sendMessage=function(a){LogUtil.logD(a);if (typeof(unityInstance)!='object')return;unityInstance.SendMessage(UNBridge.unityObjectName,"HandleMsgFromNative",a)};MessageUtil.packCallMsg=function(a,b,c){var d={};d.native_sdk_ver=UNBridge.VERSIONCODE;d.msg_id=MessageUtil.getMsgId();d.type=UNBridge.TYPE_CALL;d.callback_id=c;d.target=a;d.source=UNBridge.SOURCE_WEBGL;b&&(d.param=b);d.code=0;d.failMsg="";d.data={};return JSON.stringify(d)};
MessageUtil.packCallbackSuccessMsg=function(a,b){var c={};c.native_sdk_ver=UNBridge.VERSIONCODE;MessageUtil.copyBasic(a,c);c.code=0;c.failMsg="";c.data=b;c.param={};return JSON.stringify(c)};MessageUtil.packCallbackFailedMsg=function(a,b,c){var d={};d.native_sdk_ver=UNBridge.VERSIONCODE;MessageUtil.copyBasic(a,d);d.code=b;d.failMsg=c;d.data={};d.param={};return JSON.stringify(d)};
MessageUtil.packEventMsg=function(a,b){var c={};c.native_sdk_ver=UNBridge.VERSIONCODE;c.msg_id=MessageUtil.getMsgId();c.callback_id="";c.type=UNBridge.TYPE_EVENT;c.target=a;c.source=UNBridge.SOURCE_WEBGL;c.data=b;c.code=0;c.failMsg="";c.param={};return JSON.stringify(c)};
MessageUtil.packListenMsg=function(a){var b={};b.native_sdk_ver=UNBridge.VERSIONCODE;b.msg_id=MessageUtil.getMsgId();b.type=UNBridge.TYPE_LISTEN;b.callback_id="";b.target=a;b.source=UNBridge.SOURCE_WEBGL;b.param={};b.data={};b.code=0;b.failMsg="";return JSON.stringify(b)};MessageUtil.packlistenBackMsg=function(a){var b={};b.native_sdk_ver=UNBridge.VERSIONCODE;MessageUtil.copyBasic(a,b);b.code=0;b.failMsg="";b.data={};return JSON.stringify(b)};
MessageUtil.packUnListenMsg=function(a){var b={};b.native_sdk_ver=UNBridge.VERSIONCODE;b.msg_id=MessageUtil.getMsgId();b.type=UNBridge.TYPE_UNLISTEN;b.callback_id="";b.target=a;b.source=UNBridge.SOURCE_WEBGL;b.param={};b.data={};b.code=0;b.failMsg="";return JSON.stringify(b)};MessageUtil.packSyncCallbackMsg=function(a,b,c){var d={};d.native_sdk_ver=UNBridge.VERSIONCODE;d.code=a;d.failMsg=b;d.value=c;d.type="";return JSON.stringify(d)};
MessageUtil.copyBasic=function(a,b){b.msg_id=a.msg_id;b.type=a.type;b.callback_id=void 0===a.callback_id?"":a.callback_id;b.target=a.target;b.source=a.source};MessageUtil.getMsgId=function(){return UUID.uuidv4()};MessageUtil.getCallbackId=function(){return UUID.uuidv4()};MessageUtil.unPacketMsg=function(a){return JSON.parse(a)};var UUID=function(){};UUID.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})};
UUID.uuidv4es6=function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})};var UNBridgeCore=function(){};UNBridgeCore.handleMsgFromUnity=function(a){LogUtil.logD("handleMsgFromUnity:"+a);if(a=MessageUtil.unPacketMsg(a))if(a.source===UNBridge.SOURCE_UNITY)UNBridgeCore.onUnityCall(a);else{if(a.source===UNBridge.SOURCE_WEBGL)UNBridgeCore.onUnityCallback(a)}else LogUtil.logE("handleMsgFromUnity fail")};
UNBridgeCore.onUnityCall=function(a){LogUtil.logD("onUnityCall");switch(a.type){case UNBridge.TYPE_CALL:var b=UNBridge.apiMap[a.target];LogUtil.logD(b);if(b)b.onCall({bridgeMsg:a,callbackSuccess:function(b){MessageUtil.sendMessage(MessageUtil.packCallbackSuccessMsg(a,b))},callbackFailed:function(b,d){MessageUtil.sendMessage(MessageUtil.packCallbackFailedMsg(a,b,d))}},a.param);else MessageUtil.sendMessage(MessageUtil.packCallbackFailedMsg(a,UNBridge.CODE_API_NOT_EXIST,"api["+a.target+"] not supported."));
break;case UNBridge.TYPE_LISTEN:BridgeUtils.isInArray(UNBridge.remoteEventList,a.target)||BridgeUtils.addToArray(UNBridge.remoteEventList,a.target);MessageUtil.sendMessage(MessageUtil.packlistenBackMsg(a));break;case UNBridge.TYPE_UNLISTEN:BridgeUtils.arrayRemove(UNBridge.remoteEventList,a.target);break;case UNBridge.TYPE_EVENT:if(b=UNBridge.eventCallbackMap[a.target])if(0===a.code)b.onSuccess(a.data);else b.onFailed(a.code,a.failMsg)}};
UNBridgeCore.onUnityCallback=function(a){LogUtil.logD("onUnityCallback");switch(a.type){case UNBridge.TYPE_CALL:var b=BridgeUtils.getInMap(UNBridge.callbackMap,a.callback_id);if(void 0!==b){b=b.cb;if(0===a.code){if(b&&b.onSuccess)b.onSuccess(a.data)}else if(b&&b.onFailed)b.onFailed(a.code,a.failMsg);BridgeUtils.mapRemove(UNBridge.callbackMap,a.callback_id)}}};
UNBridgeCore.handleMsgFromUnitySync=function(a){LogUtil.logD("handleMsgFromUnitySync:"+a);if(a=MessageUtil.unPacketMsg(a)){var b=UNBridge.syncApiMap[a.target];return b?(a=b.onCall(a.param),a=MessageUtil.packSyncCallbackMsg(0,"",a),LogUtil.logD("payload:"+a),a):MessageUtil.packSyncCallbackMsg(UNBridge.CODE_API_NOT_EXIST,"",{})}LogUtil.logE("handleMsgFromUnitySync fail")};
UNBridgeCore.onUnityMixCall=function(a){LogUtil.logD("onUnityMixCall:"+a);var b=MessageUtil.unPacketMsg(a);if(!b||b.source!==UNBridge.SOURCE_UNITY)return null;a=UNBridge.apiMap[b.target];return a?void 0==a.mixCall||!1===a.mixCall?(MessageUtil.sendMessage(MessageUtil.packCallbackFailedMsg(b,UNBridge.CODE_NOT_MIX_API,"api["+b.target+"] not a mix call")),null):a.onCall({bridgeMsg:b,callbackSuccess:function(a){MessageUtil.sendMessage(MessageUtil.packCallbackSuccessMsg(b,a))},callbackFailed:function(a,
d){MessageUtil.sendMessage(MessageUtil.packCallbackFailedMsg(b,a,d))}},b.param):(MessageUtil.sendMessage(MessageUtil.packCallbackFailedMsg(b,UNBridge.CODE_API_NOT_EXIST,"api["+b.target+"] not supported.")),null)};var LogUtil=function(){};LogUtil.DEBUG=!0;LogUtil.logD=function(a){LogUtil.DEBUG&&console.log("WebGl_UNBridge[D]:"+a)};LogUtil.logE=function(a){console.log("WebGl_UNBridge[E]:"+a)};LogUtil.logW=function(a){console.log("WebGl_UNBridge[W]:"+a)};var BridgeUtils=function(){};
BridgeUtils.arrayRemove=function(a,b){if(a&&Array.isArray(a)){var c=a.indexOf(b);0<=c&&(a.splice(c,1),LogUtil.logD("arrayRemove:"+b))}};BridgeUtils.addToArray=function(a,b){a&&Array.isArray(a)&&a.push(b);LogUtil.logD(JSON.stringify(a))};BridgeUtils.isInArray=function(a,b){return a&&Array.isArray(a)?0<=a.indexOf(b):!1};BridgeUtils.mapRemove=function(a,b){a&&b&&(a[b.toString()]=void 0);LogUtil.logD("mapRemove:"+b)};BridgeUtils.isInMap=function(a,b){return a&&b?void 0!==a[b.toString()]:!1};
BridgeUtils.addToMap=function(a,b,c){a&&b&&(a[b.toString()]=c);LogUtil.logD(JSON.stringify(a))};BridgeUtils.getInMap=function(a,b){if(a&&b)return a[b.toString()]};
